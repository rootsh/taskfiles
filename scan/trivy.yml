version: '3'

tasks:
  image:
    desc: Scan vulnerability for container image
    vars:
      GIT_REPO_NAME:
        sh: basename $(git remote get-url origin) | cut -f1 -d'.'
      GIT_CURRENT_VERSION:
        sh: git tag | tr - \~ | sort -V | tr \~ - | tail -1
      REPO: '{{.REPO_NAME | default "rootsh"}}'  
      SEVERITY: '{{.SEVERITY | default "HIGH,CRITICAL"}}'
    cmds:
      - trivy image --severity {{.SEVERITY}} --format sarif --output trivy-results.sarif {{.REPO}}/{{.GIT_REPO_NAME}}:{{.GIT_CURRENT_VERSION}}
  issue:
    desc: Create Github Issue if have vulnerabilities
    vars:
      GIT_REPO:
        sh: git remote get-url origin | cut -f2 -d':' | cut -f1 -d'.'
    cmds:
      - VUL=$(jq '.runs[].tool.driver.rules[].properties | select (.precision=="very-high")' trivy-results.sarif); if [[ ! -z "$VUL" ]]; then gh issue create --title "It has vulnerability" --label security --body "Check at https://github.com/{{.GIT_REPO}}/github/security/code-scanning" --repo {{.GIT_REPO}}; else echo "No vulnerabilities"; fi
   